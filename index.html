<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Template Library - Microsoft AI Solutions</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
            color: white;
            padding: 2.5rem 0;
            text-align: center;
            margin-bottom: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .ms-logo {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 1rem;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .workflow-indicator {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .workflow-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .workflow-step {
            flex: 1;
            text-align: center;
            padding: 1rem;
            position: relative;
            min-width: 150px;
        }

        .workflow-step::after {
            content: "→";
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            color: #0078d4;
        }

        .workflow-step:last-child::after {
            display: none;
        }

        .workflow-step.active {
            color: #0078d4;
            font-weight: 600;
        }

        .workflow-step.completed {
            color: #00d4aa;
        }

        .workflow-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #e0e0e0;
            color: white;
            border-radius: 50%;
            line-height: 30px;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .workflow-step.active .workflow-number {
            background: #0078d4;
        }

        .workflow-step.completed .workflow-number {
            background: #00d4aa;
        }

        .search-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .search-box {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #0078d4;
            color: white;
        }

        .btn-primary:hover {
            background: #005a9e;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 120, 212, 0.3);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-success {
            background: #00d4aa;
            color: white;
        }

        .btn-success:hover {
            background: #00b090;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.3);
        }

        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #f0f0f0;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 200px;
        }

        .filter-label {
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }

        .filter-select {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .template-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
        }

        .template-card:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
            border-color: #0078d4;
        }

        .template-card.selected {
            border-color: #00d4aa;
            background: #f0fcf9;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .template-title {
            font-size: 1.2rem;
            color: #0078d4;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .template-type {
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
        }

        .template-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-complexity-low {
            background: #d4f4dd;
            color: #1e7e34;
        }

        .badge-complexity-medium {
            background: #fff3cd;
            color: #856404;
        }

        .badge-complexity-high {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-industry {
            background: #e3f2fd;
            color: #1565c0;
        }

        .template-description {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .template-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .metric-item {
            text-align: center;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .metric-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #0078d4;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #666;
        }

        .template-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e0e0e0;
        }

        .tag {
            padding: 0.25rem 0.5rem;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #555;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #0078d4;
            font-weight: 400;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .form-section h3 {
            color: #0078d4;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .help-text {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
            font-style: italic;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #f0f0f0;
            flex-wrap: wrap;
        }

        .deliverable-preview {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .deliverable-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .deliverable-table th,
        .deliverable-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .deliverable-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        .deliverable-table tr:hover {
            background: #f8f9fa;
        }

        .scenario-section {
            background: #f0f8ff;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }

        .scenario-header {
            font-size: 1.3rem;
            color: #0078d4;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .scenario-item {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #0078d4;
        }

        .scenario-label {
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .scenario-value {
            color: #333;
            line-height: 1.5;
        }

        .user-story-section {
            background: #e3f2fd;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }

        .user-story-item {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #0078d4;
        }

        .user-story-item h4 {
            color: #0078d4;
            margin-bottom: 0.5rem;
        }

        .import-export-section {
            background: #f0f8ff;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 2px dashed #0078d4;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background: #0078d4;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: #005a9e;
        }

        .template-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .empty-state {
            text-align: center;
            padding: 4rem;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: #555;
        }

        .empty-state-text {
            font-size: 1rem;
            color: #777;
        }

        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            min-height: 50px;
        }

        .tag-chip {
            background: #0078d4;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 16px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tag-chip .remove-tag {
            cursor: pointer;
            font-weight: bold;
        }

        .tag-input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 150px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0078d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 1.2rem;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border: 1px solid #f5c6cb;
        }

        .template-details-section {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            display: none;
        }

        .template-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .detail-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .detail-card h4 {
            color: #0078d4;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .detail-list {
            list-style: none;
            padding: 0;
        }

        .detail-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }

        .detail-list li:last-child {
            border-bottom: none;
        }

        .implementation-timeline {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            margin-top: 2rem;
        }

        .timeline-item {
            display: flex;
            align-items: start;
            margin-bottom: 1.5rem;
            position: relative;
            padding-left: 3rem;
        }

        .timeline-item::before {
            content: "";
            position: absolute;
            left: 1rem;
            top: 0.5rem;
            width: 10px;
            height: 10px;
            background: #0078d4;
            border-radius: 50%;
        }

        .timeline-item::after {
            content: "";
            position: absolute;
            left: 1.4rem;
            top: 1.5rem;
            width: 2px;
            height: calc(100% + 0.5rem);
            background: #e0e0e0;
        }

        .timeline-item:last-child::after {
            display: none;
        }

        .timeline-content h5 {
            color: #0078d4;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            .template-grid {
                grid-template-columns: 1fr;
            }

            .search-box {
                flex-direction: column;
            }

            .filter-section {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }

            .modal-content {
                padding: 1.5rem;
                width: 95%;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .btn {
                width: 100%;
            }

            .workflow-steps {
                flex-direction: column;
            }

            .workflow-step::after {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Template Library...</div>
    </div>

    <div class="container">
        <header>
            <div class="ms-logo">MICROSOFT AI ACCELERATE</div>
            <h1>Agentic Template Library</h1>
            <p class="subtitle">From Template to Custom Solution in Minutes</p>
        </header>

        <!-- Workflow Indicator -->
        <div class="workflow-indicator">
            <div class="workflow-steps">
                <div class="workflow-step active" id="step-1">
                    <div class="workflow-number">1</div>
                    <div>Search & Select Template</div>
                </div>
                <div class="workflow-step" id="step-2">
                    <div class="workflow-number">2</div>
                    <div>Customize for Client</div>
                </div>
                <div class="workflow-step" id="step-3">
                    <div class="workflow-number">3</div>
                    <div>Generate Deliverable</div>
                </div>
            </div>
        </div>

        <!-- Import/Export Section -->
        <div class="import-export-section">
            <h3 style="margin-bottom: 1rem">🚀 Quick Start Options</h3>
            <div class="template-actions">
                <button class="btn btn-secondary" onclick="templateManager.exportTemplateLibrary()">
                    📥 Export Template Library
                </button>
                <button class="btn btn-secondary" onclick="templateManager.createCustomTemplate()">
                    ➕ Create Custom Template
                </button>
                <div class="file-input-wrapper">
                    <input
                        type="file"
                        id="importDiscovery"
                        accept=".json"
                        onchange="templateManager.importDiscoveryResults(event)"
                    />
                    <label for="importDiscovery" class="file-input-label">📊 Import Discovery Results</label>
                </div>
                <div class="file-input-wrapper">
                    <input
                        type="file"
                        id="importScenario"
                        accept=".json"
                        onchange="templateManager.importScenario(event)"
                    />
                    <label for="importScenario" class="file-input-label">📤 Import Scenario</label>
                </div>
            </div>
            <div class="template-actions" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #0078d4;">
                <button class="btn btn-primary" onclick="templateManager.exportForSharePoint()">
                    📤 Export for SharePoint
                </button>
                <button class="btn btn-primary" onclick="templateManager.exportAsCSV()">
                    📊 Export as CSV
                </button>
                <div class="file-input-wrapper">
                    <input
                        type="file"
                        id="importSharePoint"
                        accept=".json,.csv"
                        onchange="templateManager.importFromSharePoint(event)"
                    />
                    <label for="importSharePoint" class="file-input-label">📥 Import from SharePoint</label>
                </div>
            </div>
            <p class="help-text" style="margin-top: 1rem">
                Import your AI Discovery results to find matching templates, or browse
                the full library below. Use SharePoint export/import for list synchronization.
            </p>
        </div>

        <!-- Step 1: Search Templates -->
        <div id="step1Content">
            <!-- Search and Filter Section -->
            <div class="search-section">
                <h3 style="margin-bottom: 1rem">
                    Find Your Perfect AI Agent Template
                </h3>
                <div class="search-box">
                    <input
                        type="text"
                        class="search-input"
                        id="searchInput"
                        placeholder="Search templates by name, description, or use case..."
                    />
                    <button class="btn btn-primary" onclick="templateManager.searchTemplates()">
                        🔍 Search
                    </button>
                    <button class="btn btn-secondary" onclick="templateManager.resetFilters()">
                        ↺ Reset
                    </button>
                </div>

                <div class="filter-section">
                    <div class="filter-group">
                        <label class="filter-label">Industry</label>
                        <select
                            class="filter-select"
                            id="industryFilter"
                            onchange="templateManager.filterTemplates()"
                        >
                            <option value="">All Industries</option>
                            <option value="financial">Financial Services</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="retail">Retail & E-commerce</option>
                            <option value="manufacturing">Manufacturing</option>
                            <option value="technology">Technology</option>
                            <option value="insurance">Insurance</option>
                            <option value="government">Government</option>
                            <option value="education">Education</option>
                            <option value="cross-industry">Cross-Industry</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Complexity</label>
                        <select
                            class="filter-select"
                            id="complexityFilter"
                            onchange="templateManager.filterTemplates()"
                        >
                            <option value="">All Complexities</option>
                            <option value="low">Low (2-4 weeks)</option>
                            <option value="medium">Medium (1-3 months)</option>
                            <option value="high">High (3-6 months)</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Agent Type</label>
                        <select
                            class="filter-select"
                            id="typeFilter"
                            onchange="templateManager.filterTemplates()"
                        >
                            <option value="">All Types</option>
                            <option value="conversational">Conversational</option>
                            <option value="analytical">Analytical</option>
                            <option value="automation">Automation</option>
                            <option value="extraction">Data Extraction</option>
                            <option value="monitoring">Monitoring</option>
                            <option value="orchestration">Orchestration</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Primary Function</label>
                        <select
                            class="filter-select"
                            id="functionFilter"
                            onchange="templateManager.filterTemplates()"
                        >
                            <option value="">All Functions</option>
                            <option value="customer-service">Customer Service</option>
                            <option value="operations">Operations</option>
                            <option value="sales">Sales</option>
                            <option value="hr">Human Resources</option>
                            <option value="finance">Finance</option>
                            <option value="it">IT Support</option>
                            <option value="compliance">Compliance</option>
                            <option value="research">Research & Analysis</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="error-message" style="display: none;"></div>

            <!-- Template Details Section (hidden by default) -->
            <div id="templateDetailsSection" class="template-details-section">
                <!-- Details will be dynamically loaded here -->
            </div>

            <!-- Template Grid -->
            <div class="template-grid" id="templateGrid">
                <!-- Templates will be dynamically loaded here -->
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none">
                <div class="empty-state-icon">🔍</div>
                <div class="empty-state-title">No Templates Found</div>
                <div class="empty-state-text">
                    Try adjusting your filters or search terms
                </div>
            </div>
        </div>

        <!-- Step 2: Customize Template -->
        <div id="step2Content" style="display: none">
            <div class="deliverable-preview">
                <h2 style="color: #0078d4; margin-bottom: 1.5rem">
                    Customize Your Solution
                </h2>

                <!-- Basic Information -->
                <div class="form-section">
                    <h3>Basic Information</h3>
                    <div class="form-group">
                        <label for="solutionName">Solution Name</label>
                        <input
                            type="text"
                            id="solutionName"
                            placeholder="e.g., Voice to CRM"
                        />
                        <p class="help-text">Give your solution a descriptive name</p>
                    </div>

                    <div class="form-group">
                        <label for="templateType">Template Type</label>
                        <select id="templateType">
                            <option value="Custom">Custom</option>
                            <option value="Pre-built">Pre-built</option>
                            <option value="Hybrid">Hybrid</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="clientName">Client/Company Name</label>
                        <input
                            type="text"
                            id="clientName"
                            placeholder="e.g., Microsoft Corporation, ACME Corp."
                        />
                    </div>

                    <div class="form-group">
                        <label for="industrySelect">Industry</label>
                        <select id="industrySelect">
                            <option value="">Select Industry</option>
                            <option value="Financial Services">Financial Services</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Retail">Retail</option>
                            <option value="Manufacturing">Manufacturing</option>
                            <option value="Technology">Technology</option>
                            <option value="Government">Government</option>
                            <option value="Education">Education</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="businessType">Business Type</label>
                        <select id="businessType">
                            <option value="B2E">B2E (Business to Employee)</option>
                            <option value="B2C">B2C (Business to Customer)</option>
                            <option value="B2B">B2B (Business to Business)</option>
                        </select>
                    </div>
                </div>

                <!-- User Stories -->
                <div class="form-section">
                    <h3>User Stories</h3>
                    <div id="userStoriesContainer">
                        <div class="form-group">
                            <label>User Story 1</label>
                            <textarea
                                class="user-story-input"
                                placeholder="As a [role], I want [feature] so that [benefit]"
                            ></textarea>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="templateManager.addUserStory()">
                        + Add User Story
                    </button>
                </div>

                <!-- General Strategy -->
                <div class="form-section">
                    <h3>General Strategy</h3>
                    <div class="form-group">
                        <label for="generalStrategy">Strategy Description</label>
                        <textarea
                            id="generalStrategy"
                            placeholder="Describe the overall strategy and approach for this solution"
                        ></textarea>
                    </div>
                </div>

                <!-- Dynamic Custom Fields -->
                <div id="customFieldsContainer">
                    <!-- Custom fields will be dynamically loaded based on template -->
                </div>

                <!-- Technical Components -->
                <div class="form-section">
                    <h3>Technical Components</h3>
                    <div class="form-group">
                        <label for="microsoftProducts">Microsoft Products</label>
                        <div class="tag-input-container" id="microsoftProductsContainer">
                            <input
                                type="text"
                                class="tag-input"
                                id="microsoftProductsInput"
                                placeholder="Type and press Enter to add"
                            />
                        </div>
                        <p class="help-text">
                            e.g., Copilot Studio, Teams, Power Automate, Dynamics 365
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="implementationApproach">Implementation Approach</label>
                        <textarea
                            id="implementationApproach"
                            placeholder="Describe the technical implementation approach"
                        ></textarea>
                    </div>
                </div>

                <!-- Success Metrics -->
                <div class="form-section">
                    <h3>Success Metrics & Scope</h3>
                    <div class="form-group">
                        <label for="successMetrics">Success Metrics</label>
                        <textarea
                            id="successMetrics"
                            placeholder="Define measurable success criteria"
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label for="scopeMvp">MVP Scope</label>
                        <textarea
                            id="scopeMvp"
                            placeholder="Define the Minimum Viable Product scope"
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label for="outOfScope">Out of Scope</label>
                        <textarea
                            id="outOfScope"
                            placeholder="Clearly define what is NOT included"
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label for="implementationPlan">Implementation Plan</label>
                        <textarea
                            id="implementationPlan"
                            placeholder="High-level implementation timeline and phases"
                        ></textarea>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="templateManager.goToStep(1)">
                        ← Back to Templates
                    </button>
                    <button class="btn btn-primary" onclick="templateManager.saveProgress()">
                        💾 Save Progress
                    </button>
                    <button class="btn btn-success" onclick="templateManager.generateDeliverable()">
                        Generate Deliverable →
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Final Deliverable -->
        <div id="step3Content" style="display: none">
            <div class="deliverable-preview">
                <h2 style="color: #0078d4; margin-bottom: 1.5rem">
                    Final Deliverable
                </h2>

                <!-- Scenario Overview -->
                <div class="scenario-section" id="scenarioOverview">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- User Stories Display -->
                <div class="user-story-section" id="userStoriesDisplay">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- Deliverable Table -->
                <table class="deliverable-table">
                    <thead>
                        <tr>
                            <th>Solution</th>
                            <th>Type</th>
                            <th>Industry</th>
                            <th>Business</th>
                            <th>Description</th>
                            <th>Technologies</th>
                            <th>Client</th>
                        </tr>
                    </thead>
                    <tbody id="deliverableTableBody">
                        <!-- Will be populated dynamically -->
                    </tbody>
                </table>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="templateManager.goToStep(2)">
                        ← Back to Customize
                    </button>
                    <button class="btn btn-primary" onclick="templateManager.exportScenario()">
                        📥 Export Scenario
                    </button>
                    <button class="btn btn-primary" onclick="templateManager.exportDeliverable()">
                        📄 Export as Document
                    </button>
                    <button class="btn btn-success" onclick="templateManager.startNewScenario()">
                        ✨ Create New Scenario
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class TemplateManager {
            constructor() {
                // GitHub repository configuration
                this.GITHUB_OWNER = 'your-github-username'; // Replace with your GitHub username
                this.GITHUB_REPO = 'ai-template-library'; // Replace with your repository name
                this.TEMPLATE_LIBRARY_URL = `https://raw.githubusercontent.com/${this.GITHUB_OWNER}/${this.GITHUB_REPO}/main/template-library.json`;
                this.TEMPLATE_DETAILS_BASE_URL = `https://raw.githubusercontent.com/${this.GITHUB_OWNER}/${this.GITHUB_REPO}/main/templates/`;

                // Local development fallback
                this.LOCAL_LIBRARY_URL = './template-library.json';
                this.LOCAL_DETAILS_BASE_URL = './templates/';

                // Template library data
                this.templateLibrary = {
                    version: "1.0",
                    lastUpdated: new Date().toISOString(),
                    templates: []
                };

                // Global state
                this.currentStep = 1;
                this.currentTemplates = [];
                this.selectedTemplate = null;
                this.selectedTemplateDetails = null;
                this.customizationData = {};
                this.taggedProducts = [];

                // Initialize
                this.init();
            }

            async init() {
                try {
                    // Show loading overlay
                    this.showLoading(true);

                    // Fetch template library from GitHub
                    await this.fetchTemplateLibrary();

                    // Initialize UI components
                    this.initializeTagInput();

                    // Load templates
                    this.loadTemplates();

                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showError('Failed to load template library. Using default templates.');
                    this.loadDefaultTemplates();
                } finally {
                    // Hide loading overlay
                    this.showLoading(false);
                }
            }

            async fetchTemplateLibrary() {
                try {
                    // First try GitHub URL
                    let response = await fetch(this.TEMPLATE_LIBRARY_URL);

                    if (!response.ok) {
                        // Fallback to local URL for development
                        console.log('GitHub fetch failed, trying local URL...');
                        response = await fetch(this.LOCAL_LIBRARY_URL);
                    }

                    if (response.ok) {
                        const data = await response.json();
                        this.templateLibrary = data;
                        this.currentTemplates = [...data.templates];
                        console.log(`Loaded ${data.templates.length} templates`);
                        return;
                    }

                    throw new Error('Failed to fetch template library');

                } catch (error) {
                    console.error('Error fetching template library:', error);
                    throw error;
                }
            }

            async fetchTemplateDetails(templateId) {
                try {
                    this.showLoading(true, 'Loading template details...');

                    // Try to fetch detailed template file
                    let detailsUrl = `${this.TEMPLATE_DETAILS_BASE_URL}${templateId}.json`;
                    let response = await fetch(detailsUrl);

                    if (!response.ok) {
                        // Fallback to local URL
                        detailsUrl = `${this.LOCAL_DETAILS_BASE_URL}${templateId}.json`;
                        response = await fetch(detailsUrl);
                    }

                    if (response.ok) {
                        const details = await response.json();
                        this.selectedTemplateDetails = details.template;
                        return details.template;
                    }

                    // If no detailed file exists, use the template from library
                    console.log(`No detailed file for ${templateId}, using library data`);
                    return this.selectedTemplate;

                } catch (error) {
                    console.error('Error fetching template details:', error);
                    // Use the basic template data as fallback
                    return this.selectedTemplate;
                } finally {
                    this.showLoading(false);
                }
            }

            loadDefaultTemplates() {
                // Default templates as fallback
                this.templateLibrary.templates = [
                    {
                        id: "voice-copilot-sales",
                        name: "Voice-Enabled Sales Assistant",
                        type: "conversational",
                        category: "sales",
                        industry: ["cross-industry"],
                        complexity: "medium",
                        description: "Voice-activated AI assistant for sales teams to create visit reports, update CRM records, and access customer information hands-free.",
                        shortDescription: "Voice-enabled CRM updates and sales support",
                        capabilities: [
                            "Voice-to-text transcription",
                            "CRM record creation/update",
                            "Natural language commands",
                            "Multi-language support",
                            "Offline capability with sync"
                        ],
                        defaultConfiguration: {
                            solutionName: "Voice to CRM",
                            businessType: "B2E",
                            userStories: [
                                "As a sales representative, I want to create visit reports using voice commands so I can document meetings immediately while details are fresh",
                                "As a sales manager, I want my team to update CRM records hands-free so they spend more time selling and less time on data entry"
                            ],
                            microsoftProducts: [
                                "Copilot Studio",
                                "Teams",
                                "Power Automate",
                                "Dynamics 365"
                            ],
                            generalStrategy: "Implement voice-enabled CRM updates through Teams integration, allowing sales reps to dictate visit reports and update opportunities using natural language commands."
                        }
                    }
                ];

                this.currentTemplates = [...this.templateLibrary.templates];
                this.loadTemplates();
            }

            showLoading(show, text = 'Loading Template Library...') {
                const overlay = document.getElementById('loadingOverlay');
                const loadingText = overlay.querySelector('.loading-text');

                if (text) {
                    loadingText.textContent = text;
                }

                if (show) {
                    overlay.classList.add('visible');
                } else {
                    overlay.classList.remove('visible');
                }
            }

            showError(message) {
                const errorElement = document.getElementById('errorMessage');
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 5000);
            }

            // Workflow Management
            goToStep(step) {
                // Update workflow indicator
                document.querySelectorAll(".workflow-step").forEach((el, index) => {
                    el.classList.remove("active", "completed");
                    if (index < step - 1) {
                        el.classList.add("completed");
                    } else if (index === step - 1) {
                        el.classList.add("active");
                    }
                });

                // Hide all steps
                document.getElementById("step1Content").style.display = "none";
                document.getElementById("step2Content").style.display = "none";
                document.getElementById("step3Content").style.display = "none";

                // Show current step
                document.getElementById(`step${step}Content`).style.display = "block";
                this.currentStep = step;

                // Hide template details if going back to step 1
                if (step === 1) {
                    document.getElementById('templateDetailsSection').style.display = 'none';
                }

                // Scroll to top
                window.scrollTo(0, 0);
            }

            // Load templates
            loadTemplates(templates = this.currentTemplates) {
                const grid = document.getElementById("templateGrid");
                const emptyState = document.getElementById("emptyState");

                if (templates.length === 0) {
                    grid.style.display = "none";
                    emptyState.style.display = "block";
                    return;
                }

                grid.style.display = "grid";
                emptyState.style.display = "none";
                grid.innerHTML = "";

                templates.forEach((template) => {
                    const card = this.createTemplateCard(template);
                    grid.appendChild(card);
                });
            }

            // Create template card
            createTemplateCard(template) {
                const card = document.createElement("div");
                card.className = "template-card";

                // Calculate estimated implementation time based on complexity
                const complexityDisplay = {
                    low: "Low Complexity",
                    medium: "Medium Complexity",
                    high: "High Complexity"
                };

                card.innerHTML = `
                    <div class="template-header">
                        <div>
                            <h3 class="template-title">${template.name}</h3>
                            <p class="template-type">${template.type} | ${template.department || template.category}</p>
                        </div>
                        <div class="template-badges">
                            <span class="badge badge-complexity-${template.complexity}">
                                ${complexityDisplay[template.complexity]}
                            </span>
                        </div>
                    </div>
                    <p class="template-description">${template.shortDescription}</p>
                    <div class="template-metrics">
                        <div class="metric-item">
                            <div class="metric-value">${template.features ? template.features.length : template.capabilities?.length || 0}</div>
                            <div class="metric-label">Features</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${template.priorityScore || 85}</div>
                            <div class="metric-label">Priority Score</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${template.industry.length}</div>
                            <div class="metric-label">Industries</div>
                        </div>
                    </div>
                    ${template.impact ? `
                    <div class="template-metrics" style="margin-top: 0.5rem;">
                        <div class="metric-item">
                            <div class="metric-value">${template.impact.hoursReduced}</div>
                            <div class="metric-label">Hours Saved</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${template.impact.tasksAutomated}</div>
                            <div class="metric-label">Tasks Automated</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value">${template.impact.qualityScore}%</div>
                            <div class="metric-label">Quality Score</div>
                        </div>
                    </div>
                    ` : ''}
                    <div class="template-tags">
                        ${template.industry.map((ind) => `<span class="tag">${ind}</span>`).join("")}
                        <span class="tag">${template.category}</span>
                    </div>
                    <div class="action-buttons" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0;">
                        <button class="btn btn-secondary" onclick="templateManager.viewTemplateDetails('${template.id}')">
                            📋 View Details
                        </button>
                        <button class="btn btn-primary" onclick="templateManager.selectTemplate('${template.id}')">
                            ✅ Select Template
                        </button>
                    </div>
                `;

                return card;
            }

            // View template details
            async viewTemplateDetails(templateId) {
                const template = this.templateLibrary.templates.find(t => t.id === templateId);
                if (!template) return;

                this.selectedTemplate = template;

                // Fetch detailed template data
                const details = await this.fetchTemplateDetails(templateId);

                // Show template details section
                const detailsSection = document.getElementById('templateDetailsSection');
                detailsSection.innerHTML = this.createTemplateDetailsHTML(details);
                detailsSection.style.display = 'block';

                // Scroll to details
                detailsSection.scrollIntoView({ behavior: 'smooth' });
            }

            createTemplateDetailsHTML(template) {
                return `
                    <h2 style="color: #0078d4; margin-bottom: 1.5rem">${template.name}</h2>
                    <p style="font-size: 1.1rem; margin-bottom: 2rem;">${template.description}</p>

                    <div class="template-details-grid">
                        ${template.requirements ? `
                        <div class="detail-card">
                            <h4>🛠️ Requirements</h4>
                            <ul class="detail-list">
                                ${template.requirements.systems ? `
                                <li><strong>Systems:</strong> ${template.requirements.systems.join(', ')}</li>
                                ` : ''}
                                ${template.requirements.skills ? `
                                <li><strong>Skills:</strong> ${template.requirements.skills.join(', ')}</li>
                                ` : ''}
                            </ul>
                        </div>
                        ` : ''}

                        ${template.technicalDetails ? `
                        <div class="detail-card">
                            <h4>⚙️ Technical Architecture</h4>
                            <ul class="detail-list">
                                ${template.technicalDetails.architecture?.backend?.runtime ? `
                                <li><strong>Runtime:</strong> ${template.technicalDetails.architecture.backend.runtime}</li>
                                ` : ''}
                                ${template.technicalDetails.architecture?.backend?.agents ? `
                                <li><strong>Agents:</strong> ${template.technicalDetails.architecture.backend.agents.length} configured</li>
                                ` : ''}
                                ${template.deployment?.cloud_provider ? `
                                <li><strong>Cloud:</strong> ${template.deployment.cloud_provider}</li>
                                ` : ''}
                            </ul>
                        </div>
                        ` : ''}

                        ${template.metrics ? `
                        <div class="detail-card">
                            <h4>📊 Expected Impact</h4>
                            <ul class="detail-list">
                                ${template.metrics.business_impact ? Object.entries(template.metrics.business_impact).map(([key, value]) => `
                                <li><strong>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong> ${value}</li>
                                `).join('') : ''}
                            </ul>
                        </div>
                        ` : ''}
                    </div>

                    ${template.implementation?.setup_steps ? `
                    <div class="implementation-timeline">
                        <h4 style="color: #0078d4; margin-bottom: 1.5rem;">📋 Implementation Steps</h4>
                        ${template.implementation.setup_steps.map((step, index) => `
                        <div class="timeline-item">
                            <div class="timeline-content">
                                <h5>Step ${index + 1}</h5>
                                <p>${step}</p>
                            </div>
                        </div>
                        `).join('')}
                    </div>
                    ` : ''}

                    <div class="action-buttons" style="margin-top: 2rem;">
                        <button class="btn btn-secondary" onclick="document.getElementById('templateDetailsSection').style.display='none'">
                            ✖️ Close Details
                        </button>
                        <button class="btn btn-primary" onclick="templateManager.selectTemplate('${template.id}')">
                            ✅ Use This Template
                        </button>
                    </div>
                `;
            }

            // Select template
            async selectTemplate(templateId) {
                const template = this.templateLibrary.templates.find(t => t.id === templateId);
                if (!template) {
                    console.error(`Template ${templateId} not found`);
                    return;
                }

                this.selectedTemplate = template;

                // Fetch detailed template data if not already loaded
                if (!this.selectedTemplateDetails || this.selectedTemplateDetails.id !== templateId) {
                    this.selectedTemplateDetails = await this.fetchTemplateDetails(templateId);
                }

                // Use the detailed template data if available
                const templateData = this.selectedTemplateDetails || template;

                // Pre-populate customization form with defaults
                if (templateData.defaultConfiguration) {
                    document.getElementById("solutionName").value = templateData.defaultConfiguration.solutionName || "";
                    document.getElementById("businessType").value = templateData.defaultConfiguration.businessType || "B2E";
                    document.getElementById("generalStrategy").value = templateData.defaultConfiguration.generalStrategy || "";

                    // Load user stories
                    const userStoriesContainer = document.getElementById("userStoriesContainer");
                    userStoriesContainer.innerHTML = "";

                    if (templateData.defaultConfiguration.userStories) {
                        templateData.defaultConfiguration.userStories.forEach((story, index) => {
                            const storyDiv = document.createElement("div");
                            storyDiv.className = "form-group";
                            storyDiv.innerHTML = `
                                <label>User Story ${index + 1}</label>
                                <textarea class="user-story-input">${story}</textarea>
                            `;
                            userStoriesContainer.appendChild(storyDiv);
                        });
                    }

                    // Load Microsoft products
                    if (templateData.defaultConfiguration.microsoftProducts) {
                        this.taggedProducts = [...templateData.defaultConfiguration.microsoftProducts];
                        this.updateTagDisplay();
                    }

                    // Load custom fields specific to this template
                    this.loadCustomFields(templateData);
                }

                // Move to customization step
                this.goToStep(2);
            }

            // Load custom fields for the selected template
            loadCustomFields(template) {
                const container = document.getElementById("customFieldsContainer");
                container.innerHTML = "";

                if (!template.defaultConfiguration?.customFields) {
                    return;
                }

                // Group fields by category
                const fieldsByCategory = {};
                template.defaultConfiguration.customFields.forEach(field => {
                    const category = field.category || "Additional Configuration";
                    if (!fieldsByCategory[category]) {
                        fieldsByCategory[category] = [];
                    }
                    fieldsByCategory[category].push(field);
                });

                // Create sections for each category
                Object.entries(fieldsByCategory).forEach(([category, fields]) => {
                    const section = document.createElement("div");
                    section.className = "form-section";
                    section.innerHTML = `<h3>${category}</h3>`;

                    fields.forEach(field => {
                        const fieldGroup = document.createElement("div");
                        fieldGroup.className = "form-group";

                        if (field.type === "textarea") {
                            fieldGroup.innerHTML = `
                                <label for="${field.name}">${field.label}</label>
                                <textarea
                                    id="${field.name}"
                                    class="custom-field"
                                    placeholder="${field.placeholder || ''}"
                                ></textarea>
                            `;
                        } else if (field.type === "text") {
                            fieldGroup.innerHTML = `
                                <label for="${field.name}">${field.label}</label>
                                <input
                                    type="text"
                                    id="${field.name}"
                                    class="custom-field"
                                    placeholder="${field.placeholder || ''}"
                                />
                            `;
                        } else if (field.type === "select" && field.options) {
                            fieldGroup.innerHTML = `
                                <label for="${field.name}">${field.label}</label>
                                <select id="${field.name}" class="custom-field">
                                    ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join("")}
                                </select>
                            `;
                        }

                        section.appendChild(fieldGroup);
                    });

                    container.appendChild(section);
                });
            }

            // Search templates
            searchTemplates() {
                const searchTerm = document.getElementById("searchInput").value.toLowerCase();

                if (!searchTerm) {
                    this.loadTemplates(this.currentTemplates);
                    return;
                }

                const filtered = this.currentTemplates.filter(
                    (template) =>
                        template.name.toLowerCase().includes(searchTerm) ||
                        template.description.toLowerCase().includes(searchTerm) ||
                        (template.capabilities && template.capabilities.some((cap) => cap.toLowerCase().includes(searchTerm))) ||
                        (template.features && template.features.some((feat) => feat.toLowerCase().includes(searchTerm)))
                );

                this.loadTemplates(filtered);
            }

            // Filter templates
            filterTemplates() {
                const industry = document.getElementById("industryFilter").value;
                const complexity = document.getElementById("complexityFilter").value;
                const type = document.getElementById("typeFilter").value;
                const category = document.getElementById("functionFilter").value;

                let filtered = [...this.templateLibrary.templates];

                if (industry) {
                    filtered = filtered.filter((t) => t.industry.includes(industry));
                }

                if (complexity) {
                    filtered = filtered.filter((t) => t.complexity === complexity);
                }

                if (type) {
                    filtered = filtered.filter((t) => t.type === type);
                }

                if (category) {
                    filtered = filtered.filter((t) => t.category === category);
                }

                this.currentTemplates = filtered;
                this.loadTemplates(filtered);
            }

            // Reset filters
            resetFilters() {
                document.getElementById("searchInput").value = "";
                document.getElementById("industryFilter").value = "";
                document.getElementById("complexityFilter").value = "";
                document.getElementById("typeFilter").value = "";
                document.getElementById("functionFilter").value = "";

                this.currentTemplates = [...this.templateLibrary.templates];
                this.loadTemplates();
            }

            // Add user story
            addUserStory() {
                const container = document.getElementById("userStoriesContainer");
                const storyCount = container.querySelectorAll(".user-story-input").length + 1;

                const storyDiv = document.createElement("div");
                storyDiv.className = "form-group";
                storyDiv.innerHTML = `
                   <label>User Story ${storyCount}</label>
                    <textarea class="user-story-input" placeholder="As a [role], I want [feature] so that [benefit]"></textarea>
                `;

                container.appendChild(storyDiv);
            }

            // Tag input functionality
            initializeTagInput() {
                const input = document.getElementById("microsoftProductsInput");
                const container = document.getElementById("microsoftProductsContainer");

                input.addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        const value = input.value.trim();
                        if (value && !this.taggedProducts.includes(value)) {
                            this.taggedProducts.push(value);
                            this.updateTagDisplay();
                            input.value = "";
                        }
                    }
                });
            }

            updateTagDisplay() {
                const container = document.getElementById("microsoftProductsContainer");
                const input = document.getElementById("microsoftProductsInput");

                // Clear existing tags
                container.querySelectorAll(".tag-chip").forEach((chip) => chip.remove());

                // Add tags
                this.taggedProducts.forEach((product) => {
                    const chip = document.createElement("div");
                    chip.className = "tag-chip";
                    chip.innerHTML = `
                        ${product}
                        <span class="remove-tag" onclick="templateManager.removeTag('${product}')">×</span>
                    `;
                    container.insertBefore(chip, input);
                });
            }

            removeTag(product) {
                this.taggedProducts = this.taggedProducts.filter((p) => p !== product);
                this.updateTagDisplay();
            }

            // Save progress
            saveProgress() {
                this.collectCustomizationData();

                const saveData = {
                    template: this.selectedTemplate,
                    templateDetails: this.selectedTemplateDetails,
                    customization: this.customizationData,
                    timestamp: new Date().toISOString()
                };

                this.downloadJSON(
                    saveData,
                    `scenario-progress-${new Date().toISOString().split("T")[0]}.json`
                );
                alert("Progress saved! You can import this file later to continue.");
            }

            // Collect customization data
            collectCustomizationData() {
                this.customizationData = {
                    solutionName: document.getElementById("solutionName").value,
                    templateType: document.getElementById("templateType").value,
                    clientName: document.getElementById("clientName").value,
                    industry: document.getElementById("industrySelect").value,
                    businessType: document.getElementById("businessType").value,
                    userStories: Array.from(document.querySelectorAll(".user-story-input"))
                        .map((input) => input.value)
                        .filter((v) => v),
                    generalStrategy: document.getElementById("generalStrategy").value,
                    microsoftProducts: this.taggedProducts,
                    implementationApproach: document.getElementById("implementationApproach").value,
                    successMetrics: document.getElementById("successMetrics").value,
                    scopeMvp: document.getElementById("scopeMvp").value,
                    outOfScope: document.getElementById("outOfScope").value,
                    implementationPlan: document.getElementById("implementationPlan").value,
                    customFields: {}
                };

                // Collect custom field values
                document.querySelectorAll(".custom-field").forEach(field => {
                    this.customizationData.customFields[field.id] = field.value;
                });
            }

            // Generate deliverable
            generateDeliverable() {
                this.collectCustomizationData();

                // Populate scenario overview
                const scenarioOverview = document.getElementById("scenarioOverview");
                scenarioOverview.innerHTML = `
                    <h3 class="scenario-header">${this.customizationData.solutionName || "AI Solution"} - Agentic Scenario</h3>
                    <div class="scenario-grid">
                        <div class="scenario-item">
                            <div class="scenario-label">Client</div>
                            <div class="scenario-value">${this.customizationData.clientName || "TBD"}</div>
                        </div>
                        <div class="scenario-item">
                            <div class="scenario-label">Industry</div>
                            <div class="scenario-value">${this.customizationData.industry || "Cross-Industry"}</div>
                        </div>
                        <div class="scenario-item">
                            <div class="scenario-label">Business Type</div>
                            <div class="scenario-value">${this.customizationData.businessType}</div>
                        </div>
                        <div class="scenario-item">
                            <div class="scenario-label">Template Type</div>
                            <div class="scenario-value">${this.customizationData.templateType}</div>
                        </div>
                    </div>
                `;

                // Populate user stories
                const userStoriesDisplay = document.getElementById("userStoriesDisplay");
                userStoriesDisplay.innerHTML = '<h3 style="color: #0078d4; margin-bottom: 1rem;">User Stories</h3>';

                this.customizationData.userStories.forEach((story, index) => {
                    const storyDiv = document.createElement("div");
                    storyDiv.className = "user-story-item";
                    storyDiv.innerHTML = `
                        <h4>Story ${index + 1}</h4>
                        <p>${story}</p>
                    `;
                    userStoriesDisplay.appendChild(storyDiv);
                });

                // Populate deliverable table
                const tableBody = document.getElementById("deliverableTableBody");
                tableBody.innerHTML = `
                    <tr>
                        <td>${this.customizationData.solutionName}</td>
                        <td>${this.customizationData.templateType}</td>
                        <td>${this.customizationData.industry}</td>
                        <td>${this.customizationData.businessType}</td>
                        <td>${this.customizationData.generalStrategy}</td>
                        <td>${this.customizationData.microsoftProducts.join(", ")}</td>
                        <td>${this.customizationData.clientName}</td>
                    </tr>
                `;

                // Add additional sections for complete scenario
                const additionalContent = document.createElement("div");

                // Build custom fields HTML dynamically
                let customFieldsHtml = "";
                const templateData = this.selectedTemplateDetails || this.selectedTemplate;
                if (templateData?.defaultConfiguration?.customFields && Object.keys(this.customizationData.customFields).length > 0) {
                    // Group custom fields by category
                    const fieldsByCategory = {};
                    templateData.defaultConfiguration.customFields.forEach(field => {
                        const category = field.category || "Additional Configuration";
                        if (!fieldsByCategory[category]) {
                            fieldsByCategory[category] = [];
                        }
                        fieldsByCategory[category].push(field);
                    });

                    // Create HTML for each category
                    Object.entries(fieldsByCategory).forEach(([category, fields]) => {
                        const categoryFields = fields.filter(field => this.customizationData.customFields[field.name]);
                        if (categoryFields.length > 0) {
                            customFieldsHtml += `
                                <div class="scenario-section">
                                    <h3 class="scenario-header">${category}</h3>
                                    <div class="scenario-grid">
                                        ${categoryFields.map(field => `
                                            <div class="scenario-item">
                                                <div class="scenario-label">${field.label}</div>
                                                <div class="scenario-value">${this.customizationData.customFields[field.name] || "N/A"}</div>
                                            </div>
                                        `).join("")}
                                    </div>
                                </div>
                            `;
                        }
                    });
                }

                additionalContent.innerHTML = `
                    <div class="scenario-section" style="margin-top: 2rem;">
                        <h3 class="scenario-header">General Strategy</h3>
                        <p>${this.customizationData.generalStrategy}</p>
                    </div>

                    ${customFieldsHtml}

                    <div class="scenario-section">
                        <h3 class="scenario-header">Discovery & Requirements</h3>
                        <p><strong>Success Metrics:</strong> ${this.customizationData.successMetrics || "TBD"}</p>
                        <p><strong>MVP Scope:</strong> ${this.customizationData.scopeMvp || "TBD"}</p>
                        <p><strong>Out of Scope:</strong> ${this.customizationData.outOfScope || "TBD"}</p>
                    </div>

                    <div class="scenario-section">
                        <h3 class="scenario-header">Technical Components</h3>
                        <p><strong>Microsoft Products:</strong> ${this.customizationData.microsoftProducts.join(", ")}</p>
                        <p><strong>Implementation Approach:</strong> ${this.customizationData.implementationApproach || "TBD"}</p>
                    </div>

                    <div class="scenario-section">
                        <h3 class="scenario-header">Implementation Plan</h3>
                        <p>${this.customizationData.implementationPlan || "TBD"}</p>
                    </div>
                `;

                // Remove any existing additional content
                const existingAdditional = document.querySelector("#step3Content .deliverable-preview > div:last-child");
                if (existingAdditional && existingAdditional.classList.contains("scenario-section")) {
                    existingAdditional.remove();
                }

                document.getElementById("step3Content").querySelector(".deliverable-preview").appendChild(additionalContent);

                this.goToStep(3);
            }

            // Export functions
            exportTemplateLibrary() {
                this.downloadJSON(
                    this.templateLibrary,
                    `agentic-template-library-${new Date().toISOString().split("T")[0]}.json`
                );
            }

            exportScenario() {
                const templateData = this.selectedTemplateDetails || this.selectedTemplate;
                const scenarioData = {
                    version: "1.0",
                    exportDate: new Date().toISOString(),
                    template: templateData,
                    customization: this.customizationData,
                    deliverable: {
                        solutionName: this.customizationData.solutionName,
                        type: this.customizationData.templateType,
                        industry: this.customizationData.industry,
                        businessType: this.customizationData.businessType,
                        description: this.customizationData.generalStrategy,
                        technologies: this.customizationData.microsoftProducts,
                        client: this.customizationData.clientName
                    }
                };

                this.downloadJSON(
                    scenarioData,
                    `scenario-${this.customizationData.solutionName.replace(/\s+/g, "-").toLowerCase()}-${new Date().toISOString().split("T")[0]}.json`
                );
            }

            exportDeliverable() {
                const templateData = this.selectedTemplateDetails || this.selectedTemplate;

                let html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${this.customizationData.solutionName} - Complete Solution Documentation</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1, h2, h3, h4 { color: #0078d4; }
        h1 { font-size: 2.5rem; margin-bottom: 1rem; }
        h2 { font-size: 1.8rem; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 2px solid #0078d4; padding-bottom: 0.5rem; }
        h3 { font-size: 1.4rem; margin-top: 1.5rem; margin-bottom: 0.8rem; }
        h4 { font-size: 1.1rem; margin-top: 1rem; margin-bottom: 0.5rem; }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .header-section {
            background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
            color: white;
            padding: 3rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }

        .header-section h1, .header-section p {
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #0078d4;
            color: white;
            font-weight: 600;
        }
        tr:hover {
            background: #f8f9fa;
        }

        .user-story {
            background: #e3f2fd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #0078d4;
        }

        .feature-list {
            list-style: none;
            padding: 0;
        }

        .feature-list li {
            padding: 0.8rem 0;
            border-bottom: 1px solid #f0f0f0;
            padding-left: 2rem;
            position: relative;
        }

        .feature-list li:before {
            content: "✓";
            color: #00d4aa;
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .metric-card {
            background: #f0f8ff;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #d0e7ff;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #0078d4;
        }

        .metric-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            margin: 1rem 0;
        }

        .timeline {
            position: relative;
            padding-left: 3rem;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 2rem;
        }

        .timeline-item:before {
            content: "";
            position: absolute;
            left: -2.5rem;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            background: #0078d4;
            border-radius: 50%;
            box-shadow: 0 0 0 4px #e3f2fd;
        }

        .timeline-item:after {
            content: "";
            position: absolute;
            left: -2.45rem;
            top: 1.5rem;
            width: 2px;
            height: calc(100% - 1rem);
            background: #e0e0e0;
        }

        .timeline-item:last-child:after {
            display: none;
        }

        .architecture-diagram {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid #e0e0e0;
        }

        .requirement-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: #e3f2fd;
            color: #0078d4;
            border-radius: 16px;
            font-size: 0.85rem;
            margin: 0.25rem;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .info-box {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        @media print {
            body {
                background: white;
            }
            .section {
                box-shadow: none;
                border: 1px solid #ddd;
            }
            .header-section {
                background: #0078d4;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <div class="header-section">
        <h1>${this.customizationData.solutionName}</h1>
        <p style="font-size: 1.2rem; opacity: 0.9;">Complete Solution Documentation - ${templateData.name}</p>
        <p style="opacity: 0.8;">Generated on ${new Date().toLocaleDateString()} for ${this.customizationData.clientName}</p>
    </div>

    <div class="section">
        <h2>Executive Summary</h2>
        <p><strong>Solution:</strong> ${this.customizationData.solutionName}</p>
        <p><strong>Client:</strong> ${this.customizationData.clientName}</p>
        <p><strong>Industry:</strong> ${this.customizationData.industry}</p>
        <p><strong>Business Type:</strong> ${this.customizationData.businessType}</p>
        <p><strong>Template Type:</strong> ${this.customizationData.templateType}</p>
        <p><strong>Complexity:</strong> ${templateData.complexity || 'Medium'}</p>
        <p><strong>Priority Score:</strong> ${templateData.priorityScore || 'N/A'}</p>

        <h3>Solution Description</h3>
        <p>${templateData.description}</p>

        <h3>General Strategy</h3>
        <p>${this.customizationData.generalStrategy}</p>
    </div>

    ${templateData.impact ? `
    <div class="section">
        <h2>Expected Business Impact</h2>
        <div class="metric-grid">
            <div class="metric-card">
                <div class="metric-value">${templateData.impact.hoursReduced}</div>
                <div class="metric-label">Hours Reduced per Month</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">${templateData.impact.tasksAutomated}</div>
                <div class="metric-label">Tasks Automated</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">${templateData.impact.qualityScore}%</div>
                <div class="metric-label">Quality Score</div>
            </div>
        </div>

        ${templateData.metrics?.business_impact ? `
        <h3>Additional Business Metrics</h3>
        <ul>
            ${Object.entries(templateData.metrics.business_impact).map(([key, value]) =>
                `<li><strong>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong> ${value}</li>`
            ).join('')}
        </ul>
        ` : ''}
    </div>
    ` : ''}

    <div class="section">
        <h2>User Stories & Requirements</h2>
        ${this.customizationData.userStories.map((story, i) =>
            `<div class="user-story"><strong>Story ${i + 1}:</strong> ${story}</div>`
        ).join("")}

        ${this.customizationData.successMetrics ? `
        <h3>Success Metrics</h3>
        <p>${this.customizationData.successMetrics}</p>
        ` : ''}

        ${this.customizationData.scopeMvp ? `
        <h3>MVP Scope</h3>
        <p>${this.customizationData.scopeMvp}</p>
        ` : ''}

        ${this.customizationData.outOfScope ? `
        <h3>Out of Scope</h3>
        <div class="warning-box">
            <p>${this.customizationData.outOfScope}</p>
        </div>
        ` : ''}
    </div>

    ${this.generateCustomFieldsHTML()}

    <div class="section">
        <h2>Solution Features</h2>
        <ul class="feature-list">
            ${(templateData.features || templateData.capabilities || []).map(feature =>
                `<li>${feature}</li>`
            ).join('')}
        </ul>
    </div>

    <div class="section">
        <h2>Technical Architecture</h2>

        ${templateData.technicalDetails ? `
        <div class="architecture-diagram">
            <h3>System Architecture</h3>
            ${templateData.technicalDetails.architecture?.backend ? `
            <h4>Backend</h4>
            <p><strong>Runtime:</strong> ${templateData.technicalDetails.architecture.backend.runtime}</p>
            ${templateData.technicalDetails.architecture.backend.mainFile ? `<p><strong>Main File:</strong> ${templateData.technicalDetails.architecture.backend.mainFile}</p>` : ''}

            ${templateData.technicalDetails.architecture.backend.agents ? `
            <h5>Agents</h5>
            <ul>
                ${templateData.technicalDetails.architecture.backend.agents.map(agent =>
                    `<li><strong>${agent.name}:</strong> ${agent.purpose}</li>`
                ).join('')}
            </ul>
            ` : ''}
            ` : ''}

            ${templateData.technicalDetails.architecture?.frontend ? `
            <h4>Frontend</h4>
            <p><strong>Type:</strong> ${templateData.technicalDetails.architecture.frontend.type}</p>
            ${templateData.technicalDetails.architecture.frontend.file ? `<p><strong>Main File:</strong> ${templateData.technicalDetails.architecture.frontend.file}</p>` : ''}
            <p><strong>Features:</strong></p>
            <ul>
                ${templateData.technicalDetails.architecture.frontend.features.map(feature =>
                    `<li>${feature}</li>`
                ).join('')}
            </ul>
            ` : ''}

            ${templateData.technicalDetails.architecture?.storage ? `
            <h4>Storage</h4>
            <p><strong>Type:</strong> ${templateData.technicalDetails.architecture.storage.type}</p>
            ${templateData.technicalDetails.architecture.storage.structure ? `
            <p><strong>Structure:</strong></p>
            <ul>
                ${Object.entries(templateData.technicalDetails.architecture.storage.structure).map(([key, value]) =>
                    `<li><strong>${key}:</strong> ${value}</li>`
                ).join('')}
            </ul>
            ` : ''}
            ` : ''}
        </div>
        ` : ''}

        <h3>Technology Stack</h3>
        <p><strong>Microsoft Products:</strong></p>
        <div>
            ${this.customizationData.microsoftProducts.map(product =>
                `<span class="requirement-badge">${product}</span>`
            ).join('')}
        </div>

        ${this.customizationData.implementationApproach ? `
        <h3>Implementation Approach</h3>
        <p>${this.customizationData.implementationApproach}</p>
        ` : ''}
    </div>

    ${templateData.requirements ? `
    <div class="section">
        <h2>Requirements</h2>

        ${templateData.requirements.systems ? `
        <h3>System Requirements</h3>
        <div>
            ${templateData.requirements.systems.map(system =>
                `<span class="requirement-badge">${system}</span>`
            ).join('')}
        </div>
        ` : ''}

        ${templateData.requirements.data ? `
        <h3>Data Requirements</h3>
        <ul>
            ${templateData.requirements.data.map(data =>
                `<li>${data}</li>`
            ).join('')}
        </ul>
        ` : ''}

        ${templateData.requirements.skills ? `
        <h3>Required Skills</h3>
        <ul>
            ${templateData.requirements.skills.map(skill =>
                `<li>${skill}</li>`
            ).join('')}
        </ul>
        ` : ''}
    </div>
    ` : ''}

    ${templateData.technicalDetails?.configuration ? `
    <div class="section">
        <h2>Configuration Details</h2>

        ${templateData.technicalDetails.configuration.environment_variables ? `
        <h3>Environment Variables</h3>
        <div class="code-block">
${templateData.technicalDetails.configuration.environment_variables.map(env => env).join('\n')}
        </div>
        ` : ''}

        ${templateData.technicalDetails.configuration.api_endpoints ? `
        <h3>API Endpoints</h3>
        <table>
            <thead>
                <tr>
                    <th>Path</th>
                    <th>Method</th>
                    <th>Authentication</th>
                    <th>Payload</th>
                </tr>
            </thead>
            <tbody>
                ${templateData.technicalDetails.configuration.api_endpoints.map(endpoint => `
                <tr>
                    <td><code>${endpoint.path}</code></td>
                    <td>${endpoint.method}</td>
                    <td>${endpoint.auth}</td>
                    <td><code>${JSON.stringify(endpoint.payload, null, 2)}</code></td>
                </tr>
                `).join('')}
            </tbody>
        </table>
        ` : ''}
    </div>
    ` : ''}

    ${templateData.implementation ? `
    <div class="section">
        <h2>Implementation Guide</h2>

        ${templateData.implementation.setup_steps ? `
        <h3>Setup Steps</h3>
        <div class="timeline">
            ${templateData.implementation.setup_steps.map((step, index) => `
            <div class="timeline-item">
                <h4>Step ${index + 1}</h4>
                <p>${step}</p>
            </div>
            `).join('')}
        </div>
        ` : ''}

        ${templateData.implementation.customization_options ? `
        <h3>Customization Options</h3>
        <ul>
            ${templateData.implementation.customization_options.map(option =>
                `<li>${option}</li>`
            ).join('')}
        </ul>
        ` : ''}

        ${this.customizationData.implementationPlan ? `
        <h3>Custom Implementation Plan</h3>
        <p>${this.customizationData.implementationPlan}</p>
        ` : ''}
    </div>
    ` : ''}

    ${templateData.codeExamples ? `
    <div class="section">
        <h2>Code Examples</h2>
        ${Object.entries(templateData.codeExamples).map(([key, example]) => `
        <h3>${example.description}</h3>
        <div class="code-block">
${example.code}
        </div>
        `).join('')}
    </div>
    ` : ''}

    ${templateData.bestPractices ? `
    <div class="section">
        <h2>Best Practices</h2>
        ${templateData.bestPractices.map(practice => `
        <h3>${practice.category}</h3>
        <ul>
            ${practice.recommendations.map(rec =>
                `<li>${rec}</li>`
            ).join('')}
        </ul>
        `).join('')}
    </div>
    ` : ''}

    ${templateData.securityConsiderations ? `
    <div class="section">
        <h2>Security Considerations</h2>

        ${templateData.securityConsiderations.authentication ? `
        <h3>Authentication</h3>
        <p><strong>Methods:</strong> ${templateData.securityConsiderations.authentication.methods.join(', ')}</p>
        <p>${templateData.securityConsiderations.authentication.implementation}</p>
        ` : ''}

        ${templateData.securityConsiderations.dataProtection ? `
        <h3>Data Protection</h3>
        <p><strong>Encryption:</strong> ${templateData.securityConsiderations.dataProtection.encryption}</p>
        <p><strong>Compliance:</strong> ${templateData.securityConsiderations.dataProtection.compliance.join(', ')}</p>
        <p><strong>Retention:</strong> ${templateData.securityConsiderations.dataProtection.retention}</p>
        ` : ''}

        ${templateData.securityConsiderations.voicePrivacy ? `
        <h3>Voice Privacy</h3>
        <ul>
            ${templateData.securityConsiderations.voicePrivacy.considerations.map(consideration =>
                `<li>${consideration}</li>`
            ).join('')}
        </ul>
        ` : ''}
    </div>
    ` : ''}

    ${templateData.troubleshooting ? `
    <div class="section">
        <h2>Troubleshooting Guide</h2>
        ${templateData.troubleshooting.commonIssues.map(issue => `
        <h3>Issue: ${issue.issue}</h3>
        <p><strong>Solutions:</strong></p>
        <ul>
            ${issue.solutions.map(solution =>
                `<li>${solution}</li>`
            ).join('')}
        </ul>
        `).join('')}
    </div>
    ` : ''}

    ${templateData.metrics ? `
    <div class="section">
        <h2>Performance Metrics</h2>

        ${templateData.metrics.performance ? `
        <h3>Performance Benchmarks</h3>
        <div class="metric-grid">
            ${Object.entries(templateData.metrics.performance).map(([key, value]) => `
            <div class="metric-card">
                <div class="metric-value">${value}</div>
                <div class="metric-label">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
            </div>
            `).join('')}
        </div>
        ` : ''}
    </div>
    ` : ''}

    ${templateData.deployment ? `
    <div class="section">
        <h2>Deployment Information</h2>
        <p><strong>Cloud Provider:</strong> ${templateData.deployment.cloud_provider}</p>
        <p><strong>Estimated Cost:</strong> ${templateData.deployment.estimated_cost}</p>
        <p><strong>Scalability:</strong> ${templateData.deployment.scalability}</p>
        <p><strong>Maintenance:</strong> ${templateData.deployment.maintenance}</p>
    </div>
    ` : ''}

    ${templateData.roadmap ? `
    <div class="section">
        <h2>Implementation Roadmap</h2>
        ${Object.entries(templateData.roadmap).map(([phase, details]) => `
        <h3>${phase.toUpperCase()} - ${details.duration}</h3>
        <h4>Deliverables:</h4>
        <ul>
            ${details.deliverables.map(deliverable =>
                `<li>${deliverable}</li>`
            ).join('')}
        </ul>
        `).join('')}
    </div>
    ` : ''}

    <div class="section">
        <h2>Solution Summary</h2>
        <table>
            <thead>
                <tr>
                    <th>Solution</th>
                    <th>Type</th>
                    <th>Industry</th>
                    <th>Business</th>
                    <th>Technologies</th>
                    <th>Client</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>${this.customizationData.solutionName}</td>
                    <td>${this.customizationData.templateType}</td>
                    <td>${this.customizationData.industry}</td>
                    <td>${this.customizationData.businessType}</td>
                    <td>${this.customizationData.microsoftProducts.join(", ")}</td>
                    <td>${this.customizationData.clientName}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="section">
        <div class="info-box">
            <h3>Document Information</h3>
            <p><strong>Generated from Template:</strong> ${templateData.name}</p>
            <p><strong>Template Version:</strong> ${templateData.version || '1.0'}</p>
            <p><strong>Document Created:</strong> ${new Date().toLocaleString()}</p>
            <p><strong>Created by:</strong> Microsoft AI Accelerate - Agentic Template Library</p>
        </div>
    </div>
</body>
</html>`;

                const blob = new Blob([html], { type: "text/html" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `${this.customizationData.solutionName.replace(/\s+/g, "-").toLowerCase()}-complete-solution.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            generateCustomFieldsHTML() {
                const templateData = this.selectedTemplateDetails || this.selectedTemplate;
                if (!templateData?.defaultConfiguration?.customFields || Object.keys(this.customizationData.customFields).length === 0) {
                    return "";
                }

                let html = "";

                // Group custom fields by category
                const fieldsByCategory = {};
                templateData.defaultConfiguration.customFields.forEach(field => {
                    const category = field.category || "Additional Configuration";
                    if (!fieldsByCategory[category]) {
                        fieldsByCategory[category] = [];
                    }
                    fieldsByCategory[category].push(field);
                });

                // Create HTML for each category
                Object.entries(fieldsByCategory).forEach(([category, fields]) => {
                    const categoryFields = fields.filter(field => this.customizationData.customFields[field.name]);
                    if (categoryFields.length > 0) {
                        html += `
                            <div class="section">
                                <h2>${category}</h2>
                                ${categoryFields.map(field => `
                                    <p><strong>${field.label}:</strong> ${this.customizationData.customFields[field.name] || "N/A"}</p>
                                `).join("")}
                            </div>
                        `;
                    }
                });

                return html;
            }

            startNewScenario() {
                // Reset form
                this.customizationData = {};
                this.selectedTemplate = null;
                this.selectedTemplateDetails = null;
                this.taggedProducts = [];

                // Clear form fields
                document.getElementById("solutionName").value = "";
                document.getElementById("templateType").value = "Custom";
                document.getElementById("clientName").value = "";
                document.getElementById("industrySelect").value = "";
                document.getElementById("businessType").value = "B2E";
                document.getElementById("generalStrategy").value = "";
                document.getElementById("implementationApproach").value = "";
                document.getElementById("successMetrics").value = "";
                document.getElementById("scopeMvp").value = "";
                document.getElementById("outOfScope").value = "";
                document.getElementById("implementationPlan").value = "";

                // Reset user stories
                const userStoriesContainer = document.getElementById("userStoriesContainer");
                userStoriesContainer.innerHTML = `
                    <div class="form-group">
                        <label>User Story 1</label>
                        <textarea class="user-story-input" placeholder="As a [role], I want [feature] so that [benefit]"></textarea>
                    </div>
                `;

                // Clear tags
                this.updateTagDisplay();

                // Clear custom fields
                document.getElementById("customFieldsContainer").innerHTML = "";

                // Remove additional content from step 3
                const additionalContent = document.querySelector("#step3Content .deliverable-preview > div:last-child");
                if (additionalContent && additionalContent.classList.contains("scenario-section")) {
                    additionalContent.remove();
                }

                // Go back to step 1
                this.goToStep(1);
            }

            // Import functions
            importDiscoveryResults(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);

                        // Extract relevant information from discovery results
                        if (imported.data && imported.data.company) {
                            document.getElementById("clientName").value = imported.data.company.name || "";

                            // Map discovery industry to our industry list
                            const industryMap = {
                                financial: "Financial Services",
                                healthcare: "Healthcare",
                                retail: "Retail",
                                manufacturing: "Manufacturing",
                                technology: "Technology",
                                government: "Government",
                                education: "Education"
                            };

                            const mappedIndustry = industryMap[imported.data.company.industry] || "Other";
                            document.getElementById("industrySelect").value = mappedIndustry;
                        }

                        // Filter templates based on use cases
                        if (imported.useCases) {
                            // Match templates based on pain points
                            const painPoints = imported.useCases
                                .map((uc) => uc.currentState?.painPoint)
                                .filter(Boolean);

                            // Filter templates that match pain points
                            const matchingTemplates = this.templateLibrary.templates.filter((template) => {
                                // Simple matching logic - can be enhanced
                                return true; // For now, show all templates
                            });

                            this.currentTemplates = matchingTemplates;
                            this.loadTemplates();
                        }

                        alert("Discovery results imported successfully!");
                        event.target.value = "";
                    } catch (error) {
                        alert("Error reading file. Please ensure it's a valid discovery results file.");
                        console.error(error);
                    }
                };

                reader.readAsText(file);
            }

            importScenario(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);

                        if (imported.template) {
                            this.selectedTemplate = imported.template;
                            this.selectedTemplateDetails = imported.templateDetails || imported.template;
                        }

                        if (imported.customization) {
                            // Populate all fields
                            const c = imported.customization;
                            document.getElementById("solutionName").value = c.solutionName || "";
                            document.getElementById("templateType").value = c.templateType || "Custom";
                            document.getElementById("clientName").value = c.clientName || "";
                            document.getElementById("industrySelect").value = c.industry || "";
                            document.getElementById("businessType").value = c.businessType || "B2E";
                            document.getElementById("generalStrategy").value = c.generalStrategy || "";
                            document.getElementById("implementationApproach").value = c.implementationApproach || "";
                            document.getElementById("successMetrics").value = c.successMetrics || "";
                            document.getElementById("scopeMvp").value = c.scopeMvp || "";
                            document.getElementById("outOfScope").value = c.outOfScope || "";
                            document.getElementById("implementationPlan").value = c.implementationPlan || "";

                            // Load user stories
                            if (c.userStories) {
                                const userStoriesContainer = document.getElementById("userStoriesContainer");
                                userStoriesContainer.innerHTML = "";

                                c.userStories.forEach((story, index) => {
                                    const storyDiv = document.createElement("div");
                                    storyDiv.className = "form-group";
                                    storyDiv.innerHTML = `
                                        <label>User Story ${index + 1}</label>
                                        <textarea class="user-story-input">${story}</textarea>
                                    `;
                                    userStoriesContainer.appendChild(storyDiv);
                                });
                            }

                            // Load Microsoft products
                            if (c.microsoftProducts) {
                                this.taggedProducts = [...c.microsoftProducts];
                                this.updateTagDisplay();
                            }

                            // Load custom fields if template is available
                            if (this.selectedTemplate || this.selectedTemplateDetails) {
                                this.loadCustomFields(this.selectedTemplateDetails || this.selectedTemplate);

                                // Populate custom field values
                                if (c.customFields) {
                                    Object.entries(c.customFields).forEach(([fieldName, value]) => {
                                        const field = document.getElementById(fieldName);
                                        if (field) {
                                            field.value = value;
                                        }
                                    });
                                }
                            }

                            this.goToStep(2);
                            alert("Scenario imported successfully!");
                        }

                        event.target.value = "";
                    } catch (error) {
                        alert("Error reading file. Please ensure it's a valid scenario file.");
                        console.error(error);
                    }
                };

                reader.readAsText(file);
            }

            createCustomTemplate() {
                const customTemplate = {
                    id: `custom-${Date.now()}`,
                    name: "New Custom Template",
                    type: "conversational",
                    category: "operations",
                    industry: ["cross-industry"],
                    complexity: "medium",
                    description: "Custom AI agent template - add your description here",
                    shortDescription: "Custom template",
                    capabilities: ["Add capabilities here"],
                    features: ["Add features here"],
                    defaultConfiguration: {
                        solutionName: "Custom Solution",
                        businessType: "B2E",
                        userStories: ["As a user, I want..."],
                        microsoftProducts: ["Copilot Studio"],
                        generalStrategy: "Define your strategy here"
                    }
                };

                // Add to library
                this.templateLibrary.templates.push(customTemplate);
                this.currentTemplates = [...this.templateLibrary.templates];

                // Refresh display
                this.loadTemplates();

                alert("Custom template created! You can now select and customize it.");
            }

            // SharePoint Export Functions
            exportForSharePoint() {
                // Convert templates to SharePoint-friendly format
                const sharePointData = this.templateLibrary.templates.map(template => {
                    return {
                        Title: template.name,
                        TemplateID: template.id,
                        TemplateType: template.type,
                        Category: template.category,
                        Industry: template.industry.join("; "), // SharePoint multi-value field
                        Complexity: template.complexity,
                        Description: template.description,
                        ShortDescription: template.shortDescription,
                        Capabilities: (template.capabilities || template.features || []).join("; "), // Multi-value field
                        SolutionName: template.defaultConfiguration?.solutionName || "",
                        BusinessType: template.defaultConfiguration?.businessType || "",
                        UserStories: template.defaultConfiguration?.userStories?.join(" ||| ") || "", // Custom delimiter
                        MicrosoftProducts: template.defaultConfiguration?.microsoftProducts?.join("; ") || "",
                        GeneralStrategy: template.defaultConfiguration?.generalStrategy || "",
                        EstimatedDuration: template.complexity === "low" ? "2-4 weeks" :
                                           template.complexity === "medium" ? "1-3 months" : "3-6 months",
                        LastModified: new Date().toISOString()
                    };
                });

                // Create metadata for SharePoint
                const exportPackage = {
                    metadata: {
                        exportType: "SharePointList",
                        exportDate: new Date().toISOString(),
                        version: this.templateLibrary.version,
                        itemCount: sharePointData.length,
                        listName: "AgenticTemplateLibrary",
                        requiredColumns: [
                            { name: "Title", type: "Text", required: true },
                            { name: "TemplateID", type: "Text", required: true },
                            { name: "TemplateType", type: "Choice", choices: ["conversational", "analytical", "automation", "extraction", "monitoring", "orchestration"] },
                            { name: "Category", type: "Choice", choices: ["sales", "operations", "customer-service", "hr", "finance", "it", "compliance", "research"] },
                            { name: "Industry", type: "Text", multiValue: true },
                            { name: "Complexity", type: "Choice", choices: ["low", "medium", "high"] },
                            { name: "Description", type: "Note" },
                            { name: "ShortDescription", type: "Text" },
                            { name: "Capabilities", type: "Note" },
                            { name: "SolutionName", type: "Text" },
                            { name: "BusinessType", type: "Choice", choices: ["B2E", "B2C", "B2B"] },
                            { name: "UserStories", type: "Note" },
                            { name: "MicrosoftProducts", type: "Note" },
                            { name: "GeneralStrategy", type: "Note" },
                            { name: "EstimatedDuration", type: "Text" },
                            { name: "LastModified", type: "DateTime" }
                        ]
                    },
                    data: sharePointData
                };

                this.downloadJSON(exportPackage, `sharepoint-template-library-${new Date().toISOString().split("T")[0]}.json`);

                // Also offer CSV export
                const csvOption = confirm("SharePoint JSON exported. Would you also like a CSV version for manual import?");
                if (csvOption) {
                    this.exportAsCSV(sharePointData);
                }
            }

            exportAsCSV(data = null) {
                // Use provided data or convert from template library
                const csvData = data || this.templateLibrary.templates.map(template => {
                    return {
                        Title: template.name,
                        TemplateID: template.id,
                        TemplateType: template.type,
                        Category: template.category,
                        Industry: template.industry.join("; "),
                        Complexity: template.complexity,
                        Description: template.description.replace(/,/g, ";"), // Replace commas
                        ShortDescription: template.shortDescription.replace(/,/g, ";"),
                        Capabilities: (template.capabilities || template.features || []).join("; "),
                        SolutionName: template.defaultConfiguration?.solutionName || "",
                        BusinessType: template.defaultConfiguration?.businessType || "",
                        UserStories: (template.defaultConfiguration?.userStories?.join(" ||| ") || "").replace(/,/g, ";"),
                        MicrosoftProducts: template.defaultConfiguration?.microsoftProducts?.join("; ") || "",
                        GeneralStrategy: (template.defaultConfiguration?.generalStrategy || "").replace(/,/g, ";"),
                        EstimatedDuration: template.complexity === "low" ? "2-4 weeks" :
                                           template.complexity === "medium" ? "1-3 months" : "3-6 months",
                        LastModified: new Date().toISOString()
                    };
                });

                // Create CSV header
                const headers = Object.keys(csvData[0]);
                let csv = headers.join(",") + "\n";

                // Add data rows
                csvData.forEach(row => {
                    const values = headers.map(header => {
                        const value = row[header];
                        // Escape quotes and wrap in quotes if contains special characters
                        if (value && (value.includes(",") || value.includes('"') || value.includes("\n"))) {
                            return `"${value.replace(/"/g, '""')}"`;
                        }
                        return value;
                    });
                    csv += values.join(",") + "\n";
                });

                // Download CSV
                const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `sharepoint-templates-${new Date().toISOString().split("T")[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            importFromSharePoint(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        if (file.name.endsWith(".csv")) {
                            // Parse CSV
                            this.parseSharePointCSV(e.target.result);
                        } else {
                            // Parse JSON
                            const imported = JSON.parse(e.target.result);

                            if (imported.metadata && imported.metadata.exportType === "SharePointList") {
                                // Convert SharePoint format back to template format
                                const templates = imported.data.map(item => {
                                    return {
                                        id: item.TemplateID,
                                        name: item.Title,
                                        type: item.TemplateType,
                                        category: item.Category,
                                        industry: item.Industry.split(";").map(i => i.trim()).filter(i => i),
                                        complexity: item.Complexity,
                                        description: item.Description,
                                        shortDescription: item.ShortDescription,
                                        capabilities: item.Capabilities.split(";").map(c => c.trim()).filter(c => c),
                                        features: item.Capabilities.split(";").map(c => c.trim()).filter(c => c),
                                        defaultConfiguration: {
                                            solutionName: item.SolutionName,
                                            businessType: item.BusinessType,
                                            userStories: item.UserStories ? item.UserStories.split(" ||| ").filter(s => s) : [],
                                            microsoftProducts: item.MicrosoftProducts ? item.MicrosoftProducts.split(";").map(p => p.trim()).filter(p => p) : [],
                                            generalStrategy: item.GeneralStrategy
                                        }
                                    };
                                });

                                // Update template library
                                this.templateLibrary.templates = templates;
                                this.templateLibrary.lastUpdated = new Date().toISOString();
                                this.templateLibrary.version = imported.metadata.version || "1.0";

                                this.currentTemplates = [...templates];
                                this.loadTemplates();

                                alert(`Successfully imported ${templates.length} templates from SharePoint!`);
                            } else {
                                alert("Invalid SharePoint export file format.");
                            }
                        }

                        event.target.value = "";
                    } catch (error) {
                        alert("Error reading file. Please ensure it's a valid SharePoint export file.");
                        console.error(error);
                    }
                };

                reader.readAsText(file);
            }

            parseSharePointCSV(csvText) {
                const lines = csvText.split("\n").filter(line => line.trim());
                const headers = lines[0].split(",").map(h => h.trim().replace(/^"/, "").replace(/"$/, ""));

                const templates = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = this.parseCSVLine(lines[i]);
                    const item = {};

                    headers.forEach((header, index) => {
                        item[header] = values[index] || "";
                    });

                    // Clean up the data - remove quotes and trim
                    Object.keys(item).forEach(key => {
                        if (typeof item[key] === "string") {
                            item[key] = item[key].replace(/^"/, "").replace(/"$/, "").trim();
                        }
                    });

                    // Convert to template format
                    const template = {
                        id: item.TemplateID || item.templateID || "",
                        name: item.Title || item.title || "",
                        type: item.TemplateType || item.templateType || "conversational",
                        category: item.Category || item.category || "operations",
                        industry: item.Industry ? item.Industry.split(";").map(i => i.trim()).filter(i => i) : ["cross-industry"],
                        complexity: item.Complexity || item.complexity || "medium",
                        description: item.Description || item.description || "",
                        shortDescription: item.ShortDescription || item.shortDescription || "",
                        capabilities: item.Capabilities ? item.Capabilities.split(";").map(c => c.trim()).filter(c => c) : [],
                        features: item.Capabilities ? item.Capabilities.split(";").map(c => c.trim()).filter(c => c) : [],
                        defaultConfiguration: {
                            solutionName: item.SolutionName || item.solutionName || "",
                            businessType: item.BusinessType || item.businessType || "B2E",
                            userStories: item.UserStories ? item.UserStories.split(" ||| ").map(s => s.trim()).filter(s => s) : [],
                            microsoftProducts: item.MicrosoftProducts ? item.MicrosoftProducts.split(";").map(p => p.trim()).filter(p => p) : [],
                            generalStrategy: item.GeneralStrategy || item.generalStrategy || ""
                        }
                    };

                    // Only add valid templates
                    if (template.id && template.name) {
                        templates.push(template);
                    }
                }

                // Update template library
                if (templates.length > 0) {
                    this.templateLibrary.templates = templates;
                    this.templateLibrary.lastUpdated = new Date().toISOString();
                    this.templateLibrary.version = "1.0"; // Default version since it's not in the CSV

                    this.currentTemplates = [...templates];
                    this.loadTemplates();

                    alert(`Successfully imported ${templates.length} templates from SharePoint CSV!`);
                } else {
                    alert("No valid templates found in the CSV file. Please check the file format.");
                }
            }

            parseCSVLine(line) {
                const values = [];
                let current = "";
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"') {
                        if (inQuotes && line[i + 1] === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === "," && !inQuotes) {
                        values.push(current.trim());
                        current = "";
                    } else {
                        current += char;
                    }
                }

                values.push(current.trim());
                return values;
            }

            // Helper function
            downloadJSON(data, filename) {
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // Initialize template manager when DOM is loaded
        let templateManager;
        document.addEventListener("DOMContentLoaded", () => {
            templateManager = new TemplateManager();
        });
    </script>
</body>
</html>
